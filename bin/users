#!/bin/bash

DIR="$(dirname "$0")"
. "${DIR}/config"

set -o errexit
set -o pipefail

psql -d gh -XAt -c "SELECT DISTINCT user_id FROM events WHERE user_id NOT IN (SELECT id FROM users) order by 1" \
    | while read -a user ; do
    USER_ID=${user[0]}
    echo "Getting user: ${USER_ID}..."
    curl -s \
         -H "Authorization: token ${GITHUB_ACCESS_TOKEN}" \
         -H "Accept: application/vnd.github.v3+json" \
         "${API_URL}/users/${USER_ID}" \
         --output ./data/user-${USER_ID}.json

    # extract user detail 
    cat ./data/user-${USER_ID}.json | jq -r \
        '[.login, .name, .company, .location, .email, (.created_at | .[0:10])] | @csv' \
        >> /tmp/users-${GITHUB_ORG_NAME}.csv

    # remove the temp file
    rm -f ./data/user-${USER_ID}.json

done

# import
psql gh -c "COPY users_raw FROM '/tmp/users-${GITHUB_ORG_NAME}.csv' delimiter ',' csv;"

# cleanup 
rm -r /tmp/users-${GITHUB_ORG_NAME}.csv